# Архитектура системы

Проект будет построен на **микросервисной архитектуре**, где каждый компонент является независимым сервисом, упакованным в **Docker-контейнер**. Это обеспечит масштабируемость, изоляцию компонентов и простоту модификации в будущем.

## 1. Микросервисы

Микросервисы:
- `users-service`: Управление аутентификацией (регистрация, вход), ролями пользователей (заказчик, поставщик, оператор). **(Реализован)**
- `companies-service`: Управление данными компаний. В MVP реализован эндпоинт для получения списка компаний и эндпоинт для сохранения результатов анкеты о мерах поддержки. **(Реализован)**
- `products-service`: Управление продуктами и их характеристиками. (В планах)
- `orders-service`: Управление заказами, оставляемыми заказчиками. (В планах)
- `operator-service`: Панель оператора, управление мерами поддержки, аналитика. Реализованы эндпоинты:
    - `GET /companies/region/:regionName` - получение списка компаний по региону.
    - `GET /api/operator/support-stats` - получение статистики для дашборда мер поддержки.
    - `GET /api/operator/company-by-inn/:inn` - поиск компании по ИНН.
    - `POST /api/operator/confirm-support` - сохранение подтвержденных мер поддержки.
- `uploads-service`: Отвечает за загрузку файлов в облачное хранилище и выдачу ссылок. (В планах)

### Оркестрация
Все сервисы, включая базу данных, управляются и запускаются с помощью `Docker Compose`. Конфигурация находится в файле `docker-compose.yml` в корне проекта. 

**Единая точка входа для разработки**: `npm run dev` из корневой директории проекта автоматически запускает:
- Все микросервисы в Docker контейнерах (`docker-compose up --build`)
- React фронтенд с Hot Reload (`npm run frontend:start`)
- Вывод ссылок на все сервисы для удобства разработки

Это обеспечивает полную среду разработки одной командой с автоматическим перезапуском при изменении кода.

## 3. Детальное описание сервисов

### users-service
- **Ответственность**: Регистрация, вход, управление профилями и ролями пользователей.
- **Технологии**: Node.js, Express, PostgreSQL (pg).
- **Зависимости**: `express`, `pg`, `dotenv`, `jsonwebtoken`, `bcryptjs`.

### companies-service
- **Ответственность**: Предоставление базовой информации о компаниях и сохранение результатов опросов.
- **Технологии**: Node.js, Express, PostgreSQL (pg).
- **Зависимости**: `express`, `pg`, `dotenv`, `cors`.

### operator-service
- **Ответственность**: Предоставление всей бизнес-логики для панели оператора.
- **Логика**: Управляет всей бизнес-логикой, доступной только операторам:
  - Поиск компаний по ИНН.
  - Подтверждение фактов получения мер поддержки.
  - Получение агрегированной статистики для дашбордов.
  - Получение истории грантов для конкретной компании.
- **Технологии**: Node.js, Express, PostgreSQL (pg).
- **Зависимости**: `express`, `pg`, `dotenv`, `jsonwebtoken`, `cors`.

---

## 4. Принципы безопасности

Безопасность является приоритетом с самого начала разработки.

-   **Аутентификация и Авторизация**:
    -   **JWT (JSON Web Tokens)**: Используется для аутентификации во всей системе. Токен выдается `users-service` после успешного входа или регистрации и затем валидируется каждым сервисом (или на уровне API-шлюза). 
    -   **Хеширование паролей**: Пароли хранятся в БД в виде хешей с использованием `bcrypt` и "соли".

### Как работает хеширование паролей?

Хеширование — это **односторонний** криптографический процесс, который является основой безопасности паролей в приложении.

1.  **Процесс:** Когда пользователь регистрируется, его пароль (например, `password123`) не сохраняется в базу данных напрямую. Вместо этого, он проходит через хеш-функцию (`bcrypt`), которая превращает его в уникальный набор символов (хеш), например `$2b$10$...`. Только этот хеш записывается в БД.
2.  **Роль "соли" (Salt):** Ключевой особенностью `bcrypt` является автоматическое добавление "соли" — случайной строки, которая смешивается с паролем *перед* хешированием. Эта "соль" сохраняется как часть итогового хеша. Благодаря этому, даже если два пользователя выберут одинаковый пароль, их хеши в базе данных будут абсолютно разными.
3.  **Проверка при входе:** Когда пользователь входит в систему, `bcrypt` извлекает "соль" из хеша, хранящегося в БД, добавляет ее к введенному паролю и хеширует результат. Если новый хеш совпадает с хешем в базе — доступ разрешен.
4.  **Безопасность:** Ключевое свойство хеширования в том, что оно необратимо. Даже если злоумышленник получит доступ к базе данных, он увидит только бессмысленные хеши, из которых **невозможно** восстановить исходные пароли пользователей. Это защищает учетные данные, даже в случае утечки данных.

    -   **Разделение ролей**: Доступ к эндпоинтам строго контролируется на основе роли пользователя (`customer`, `supplier`, `operator`).
-   **Защита API**:
    -   **HTTPS**: Все коммуникации шифруются с помощью SSL/TLS.
    -   **Валидация данных**: Все входящие данные на бэкенде проходят строгую валидацию для предотвращения SQL-инъекций, XSS и других атак.
    -   **Rate Limiting**: Будет настроено ограничение частоты запросов для защиты от DoS-атак.
-   **Инфраструктура**:
    -   **Изоляция в Docker**: Контейнеризация обеспечивает изоляцию сервисов.
    -   **Управление секретами**: Чувствительные данные (ключи API, пароли к БД) хранятся в переменных окружения (`.env` файлы) и не должны попадать в систему контроля версий.
    -   **Фаервол**: (План на будущее) Настройка правил для ограничения доступа к внутренним сервисам, таким как база данных.

## 3. Разделение окружений (Dev/Prod)

Для обеспечения стабильности и безопасности используется разделение на среду разработки (`development`) и рабочую среду (`production`).

-   **Конфигурация**: Управление через файлы `.env.development` и `.env.production`.
-   **Скрипты запуска**: `package.json` будет содержать скрипты для запуска в разных режимах:
    -   `npm run dev`: Запуск в режиме разработки с использованием `nodemon` для автоматического перезапуска бэкенд-сервисов и `react-scripts start` для фронтенда с Hot Reload.
    -   `npm start`: Запуск в рабочем режиме с оптимизированными настройками.
-   **Логика в коде**: В коде будет использоваться `process.env.NODE_ENV` для выполнения специфичной для окружения логики.

## 4. Планы на будущее (закладывается в архитектуру)

-   **Telegram Mini App**: Архитектура предусматривает возможность интеграции с Telegram Mini App. Аутентификация будет основана на `WebAppInitData` для бесшовной связи между веб-сайтом и приложением в Telegram.
-   **Логирование в Telegram-бот**: Система будет поддерживать отправку логов об ошибках в специальный Telegram-бот. Токен бота будет храниться в переменных окружения с пометкой `dev` или `prod`.
-   **Резервное копирование**: Будет настроена система регулярного резервного копирования базы данных.
